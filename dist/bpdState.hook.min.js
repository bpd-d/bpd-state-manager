!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("bpdState",[],e):"object"==typeof exports?exports.bpdState=e():t.bpdState=e()}(window,(function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=3)}([function(t,e,r){"use strict";function n(t){return null!=t&&((!Array.isArray(t)||0!==t.length)&&("string"==typeof t&&t.length,!0))}function*i(){let t=0;for(;;){((yield t++)||t>2e5)&&(t=0)}}r.d(e,"b",(function(){return n})),r.d(e,"a",(function(){return i}))},function(t,e,r){"use strict";r.d(e,"c",(function(){return i})),r.d(e,"f",(function(){return o})),r.d(e,"b",(function(){return s})),r.d(e,"d",(function(){return c})),r.d(e,"a",(function(){return u})),r.d(e,"e",(function(){return a}));class n extends Error{constructor(t,e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=t}}class i extends n{constructor(t){super("IncorrectDataError",t)}}class o extends n{constructor(t){super("WorkerNotReadyError",t)}}class s extends n{constructor(t){super("CreateStateError",t)}}class c extends n{constructor(t){super("InitStateError",t)}}class u extends n{constructor(t,e){super(t,e)}}class a extends n{constructor(t,e){super("StateManagerShorthandError",t+":"+e)}}},function(t,e,r){"use strict";r.r(e),r.d(e,"VERSION_INFO",(function(){return b})),r.d(e,"BpdStateManagerFactory",(function(){return f}));var n=r(1),i=r(0);class o{constructor(){this._states=[],this._maxCount=20}push(t){this._states.length>=this._maxCount&&this._states.shift(),this._states.push(t)}undo(){if(this._states.length>0)return this._states.pop()}length(){return this._states.length}}class s{copy(t){if(null==t)return t;let e=null;return e=["number","string","boolean"].includes(typeof t)||Array.isArray(t)?t:Object.assign({},t),e}}var c=function(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{u(n.next(t))}catch(t){o(t)}}function c(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,c)}u((n=n.apply(t,e||[])).next())}))};class u{constructor(t){if(!Object(i.b)(t))throw new n.c("Valid Id is required");this._subscribers=[],this._id=t,this._counter=Object(i.a)(),this._onError=void 0}subscribe(t,e){let r=this.createSubscriber(t,e);return this._subscribers.push(r),r.id}unsubscribe(t){if(!Object(i.b)(t))return;let e=this._subscribers.findIndex(e=>e.id===t);e<0||this._subscribers.splice(e,1)}notify(t){return c(this,void 0,void 0,(function*(){let e=[];return this._subscribers.forEach(r=>{r.options&&r.options.singleRun&&e.push(r.id);try{r.callback(t)}catch(t){e.push(r.id),this._onError&&this._onError(t)}}),e.forEach(t=>this.unsubscribe(t)),!0}))}onError(t){this._onError=t}getSubscribers(){return[...this._subscribers]}createSubscriber(t,e){return{id:this.generateId(),options:e,callback:t}}generateId(){return`${this._id}:${this._counter.next().value}`}}class a{constructor(){this._queue=[],this._lock=!1,this._queuelock=!1,this._onError=void 0,this._onPerform=void 0,this._onUpdate=void 0}onPerform(t){this._onPerform=t}onUpdate(t){this._onUpdate=t}onError(t){this._onError=t}perform(t){if(!Object(i.b)(t))throw new n.c("Inproper action object passed to worker");if(!Object(i.b)(this._onPerform)||!Object(i.b)(this._onUpdate))throw new n.f("Callbacks are not set");this.isInQueue(t)||this._queue.push(t),this.run()}run(){if(this._queuelock||this._lock||!Object(i.b)(this._queue))return;this._lock=!0;let t=this._queue.shift();t||(this._lock=!1,this.run()),this._onPerform&&t&&this._onPerform(t).then(e=>{this._onUpdate&&this._onUpdate(e,t),this._lock=!1,this.run()}).catch(e=>{this._onError&&this._onError(e,t)})}isInQueue(t){this._queuelock=!0;let e=this._queue.findIndex(e=>t.action===e.action&&e.data===t.data);return this._queuelock=!1,e>-1}}class h{constructor(t,e,r,c){var h;if(!Object(i.b)(t))throw new n.d("State id must be provided");if(!Object(i.b)(e))throw new n.d("Initial value must be a valid, initialized object");if(!Object(i.b)(r))throw new n.d("Perfromer callback was not provided");this._id=t,this._state=e,this._config=null!=c?c:{},this._mutationHandler=r,this._worker=new a,this._worker.onUpdate(this.onWorkerChange.bind(this)),this._worker.onPerform(this.onWorkerPerform.bind(this)),this._worker.onError(this.onWorkerError.bind(this)),this._subscriptionManager=new u(this._id),this._subscriptionManager.onError(this.onSubscriberError.bind(this)),this._copyMaker=null!==(h=this._config.copyMaker)&&void 0!==h?h:new s,this._backup=new o}perform(t,e){Object(i.b)(t)||this.reportError("lib","In proper action object",new n.c("In proper action object")),e&&this._subscriptionManager.subscribe(e,{singleRun:!0}),this._worker.perform(t)}subscribe(t){if(Object(i.b)(t))return this._subscriptionManager.subscribe(t);this.reportError("lib","",new n.c("Callback has not been set"))}unsubscribe(t){return!!Object(i.b)(t)&&(this._subscriptionManager.unsubscribe(t),!0)}getState(){return this._copyMaker.copy(this._state)}undo(){this._worker.perform({action:"$$UNDO_FROM_BACKUP"})}onWorkerChange(t,e){e&&"$$UNDO_FROM_BACKUP"===e.action?this.assignStateAndNotify(t,"lib","Undo from backup"):(this._backup.push(this._copyMaker.copy(this._state)),this.assignStateAndNotify(t,"action",e?e.action:""))}onWorkerPerform(t){return t&&"$$UNDO_FROM_BACKUP"===t.action?new Promise(t=>{let e=this._backup.undo();t(null!=e?e:this._copyMaker.copy(this._state))}):new Promise(e=>{e(this._mutationHandler(this._copyMaker.copy(this._state),t))})}onWorkerError(t,e){this.reportError("action",e?e.action:"",t)}onSubscriberError(t){this.reportError("lib","Subscribers error",t)}reportError(t,e,r){this._config&&this._config.onError&&this._config.onError(this._id,t,r,e)}reportChange(t,e){this._config&&this._config.onChange&&this._config.onChange(this._id,t,e,this._state)}assignStateAndNotify(t,e,r){this._state=this._copyMaker.copy(t),this._subscriptionManager.notify(t).then(t=>{this.reportChange(e,r)}).catch(t=>{this.reportError(e,r,t)})}}const b="0.2.0";class f{constructor(t){this._config=t,this._states=new Map}createState(t,e,r,o){if(!Object(i.b)(t)||Object(i.b)(this._states.get(t)))throw new n.b("State name was not provided");this._states.set(t,new h(t,e,r,null!=o?o:this._config))}removeState(t){this.executeIfValid(t,"RemoveSate",e=>{this._states.delete(t)})}getState(t){let e=void 0;return this.executeIfValid(t,"GetState",t=>{e=t}),e}perform(t,e,r){this.executeIfValid(t,"Perform",t=>{t.perform(e,r)})}subscribe(t,e){let r=void 0;return this.executeIfValid(t,"Subscribe",t=>{r=t.subscribe(e)}),r}unsubscribe(t,e){this.executeIfValid(t,"Unsubscribe",t=>{t.unsubscribe(e)})}undo(t){this.executeIfValid(t,"Undo",t=>{t.undo()})}executeIfValid(t,e,r){if(!Object(i.b)(t))throw new n.a(e+"Error","State name is not provided");let o=this._states.get(t);if(!Object(i.b)(o))throw new n.a(e+"StateError","State not found");r(o)}}},function(t,e,r){"use strict";r.r(e),r.d(e,"createStateManager",(function(){return u})),r.d(e,"createState",(function(){return a})),r.d(e,"removeState",(function(){return h})),r.d(e,"getState",(function(){return b})),r.d(e,"performStateAction",(function(){return f})),r.d(e,"subscribeToState",(function(){return d})),r.d(e,"unsubscribeFromState",(function(){return l})),r.d(e,"undoState",(function(){return p}));var n=r(2),i=r(1),o=r(0);let s=void 0;function c(){if(!Object(o.b)(s))throw new i.e("createState","Manager must be initialized first with createStateManager");return s}function u(t){if(Object(o.b)(s))throw new i.e("createStateManager","Manager was already initialized");s=new n.BpdStateManagerFactory(t)}function a(t,e,r,n){c().createState(t,e,r,n)}function h(t){c().removeState(t)}function b(t){return c().getState(t)}function f(t,e,r){c().perform(t,e,r)}function d(t,e){return c().subscribe(t,e)}function l(t,e){c().unsubscribe(t,e)}function p(t){c().undo(t)}}])}));
//# sourceMappingURL=bpdState.hook.min.js.map